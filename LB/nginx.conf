worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # DNS pra resolver os domínios do Railway
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=10s;

    # Upstream com as duas instâncias (ajusta os domínios se forem diferentes)
    upstream api_backend {
        least_conn;
        server api-instance-a-production.up.railway.app;
        server api-instance-b-production.up.railway.app;
    }

    # CORS – libera o front (ajusta origens se precisar)
    map $http_origin $cors_origin {
        default "";
        "~^https?://localhost:5173$"                           $http_origin;
        "~^https?://load-balancer-sd-production.up.railway.app$" $http_origin;
    }

    server {
        # ATENÇÃO: use aqui a mesma porta da variável PORT do serviço no Railway
        # se no Railway está PORT=8880, deixe assim:
        listen 8880;
        server_name _;

        # CORS pra todas as respostas
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials true         always;
        add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers     "Authorization, Content-Type"            always;

        # Pré-flight
        if ($request_method = OPTIONS) {
            return 204;
        }

        location / {
            proxy_pass https://api_backend;

            proxy_set_header Host              $proxy_host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_ssl_server_name on;

            # Buffers um pouco maiores pra evitar "too big header"
            proxy_buffer_size       16k;
            proxy_buffers           8 16k;
            proxy_busy_buffers_size 32k;

            proxy_connect_timeout   10s;
            proxy_send_timeout      60s;
            proxy_read_timeout      60s;
        }
    }
}
